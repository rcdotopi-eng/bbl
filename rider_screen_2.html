<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink - Request Ride</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        .hidden { display: none; }
        .gps-status { font-size: 12px; margin-top: 5px; color: #666; }
        .gps-error { color: #dc3545; font-weight: bold; }
        .gps-success { color: #28a745; font-weight: bold; }
        .btn-primary { padding: 10px 15px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .btn-secondary { padding: 10px 15px; background: #6c757d; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .btn-danger { padding: 5px 10px; background: #dc3545; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin:0;">ğŸš– RideLink</h2>
        <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 12px; background: #eee; color: #333;">Logout</button>
    </div>

    <!-- âœ… TAB BUTTONS -->
    <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="btn-primary" onclick="showTab('request')">ğŸš• Request Ride</button>
        <button class="btn-secondary" onclick="showTab('history')">ğŸ“œ History</button>
    </div>

    <div id="screen-loading" class="card" style="text-align: center;">
        <p>Checking profile & active rides...</p>
    </div>

    <!-- ğŸš• REQUEST FORM -->
    <div id="screen-form" class="card hidden">
        <h3>Request a Ride</h3>

        <div class="input-group">
            <label>Pickup Location</label>
            <input type="text" id="pickup" placeholder="Enter Pickup Point">
        </div>

        <div class="input-group">
            <label>Drop Point</label>
            <input type="text" id="drop" placeholder="Enter Destination">
        </div>

        <div class="input-group">
            <label>Vehicle Type</label>
            <select id="vehicle">
                <option value="Bike">Bike ğŸï¸</option>
                <option value="Rickshaw">Rickshaw ğŸ›º</option>
                <option value="Car">Car ğŸš—</option>
            </select>
        </div>

        <div class="input-group">
            <label>Your Phone</label>
            <input type="text" id="phone" readonly style="background: #eee; color: #555;">
        </div>

        <div id="gps-area" style="margin-bottom: 15px;">
            <p id="gps-msg" class="gps-status">ğŸ“ GPS coordinates required</p>
            <button id="btn-manual-gps" class="btn-primary hidden" onclick="getGPS()" style="background:#6c757d;">
                ğŸ“ Click to Fetch GPS Manually
            </button>
        </div>

        <!-- âœ… REAL SUBMIT & RESET BUTTONS -->
        <button id="btn-submit" class="btn-primary" onclick="submitRide()">
            ğŸš• Submit Ride Request
        </button>
        <button id="btn-reset" class="btn-secondary" onclick="resetForm()">
            Reset
        </button>

    </div>

    <!-- ğŸ“œ HISTORY SCREEN WITH BACK BUTTON -->
<div id="tab-history" class="card hidden" style="margin-top: 10px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <button class="btn-secondary" onclick="showTab('request')" style="font-size:12px;">
            â¬… Back
        </button>
        <h3 style="margin:0;">ğŸ“œ Ride History</h3>
        <button class="btn-danger" onclick="clearAllHistory()" style="font-size:12px;">
            Clear All
        </button>
    </div>

    <ul id="rideList" style="list-style:none; padding:0; margin-top:10px;"></ul>
</div>


    <!-- âœ… STATUS SCREEN -->
    <div id="screen-status" class="card hidden" style="text-align: center;">
        <div style="font-size: 40px;">âœ…</div>
        <h3 style="color: #28a745;">Request Successfully Sent</h3>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: left;">
            <p><strong>Status:</strong> <span style="color: #e67e22; font-weight: bold;">Pending (Waiting for Drivers)</span></p>
            <p><strong>Pickup:</strong> <span id="lbl-pickup">...</span></p>
            <p><strong>Drop:</strong> <span id="lbl-drop">...</span></p>
            <p><strong>Vehicle:</strong> <span id="lbl-vehicle">...</span></p>
        </div>

        <button disabled style="background: #ddd; color: #555; cursor: default; margin-bottom: 10px;">
            Submitted (Waiting...)
        </button>
        
        <button class="btn-danger" onclick="cancelCurrentRide()">
            Cancel Request
        </button>
    </div>

</div>

<script src="firebase-init.js"></script>
<script src="rider_logic.js"></script>
<script>
let currentUser = null;
var currentRideId = null;
let userProfile = null;
let userLocation = null;

// --- AUTH & PROFILE CHECK ---
firebase.auth().onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        initialCheck();
    } else {
        window.location.href = "index.html";
    }
});

function initialCheck() {
    const uid = currentUser.uid;
    db.ref('users/' + uid).once('value').then(snap => {
        if (!snap.exists()) return window.location.href = "index.html";
        userProfile = snap.val();

        if (userProfile.riderStatus !== 'active') {
            alert("Account not active. Please complete registration.");
            window.location.href = "index.html";
            return;
        }

        if (!userProfile.wallet || userProfile.wallet < 250) {
            alert("âŒ Insufficient wallet balance.\nMinimum Rs.250 required to book a ride.");
            window.location.href = "wallet.html";
            return;
        }

        checkForActiveRides();
    });
}

function checkForActiveRides() {
    db.ref('requests').orderByChild('riderId').equalTo(currentUser.uid)
      .limitToLast(1).once('value').then(snap => {
        
        let hasActive = false;
        let activeRideData = null;
        let activeRideKey = null;

        snap.forEach(child => {
            const r = child.val();
            if (['pending','accepted','confirmed'].includes(r.status)) {
                hasActive = true;
                activeRideData = r;
                activeRideKey = child.key;
            }
        });

        document.getElementById('screen-loading').classList.add('hidden');

        if (hasActive) {
            currentRideId = activeRideKey;
            showStatusScreen(activeRideData);
        } else {
            showFormScreen();
        }
    });
}

// --- SCREEN LOGIC ---
function showFormScreen() {
    document.getElementById('screen-form').classList.remove('hidden');
    document.getElementById('screen-status').classList.add('hidden');
    document.getElementById('tab-history').classList.add('hidden');

    document.getElementById('phone').value = userProfile.phone || "No Phone Found";
    getGPS(true);
}

function showStatusScreen(rideData) {
    document.getElementById('screen-form').classList.add('hidden');
    document.getElementById('screen-status').classList.remove('hidden');
    document.getElementById('tab-history').classList.add('hidden');

    document.getElementById('lbl-pickup').innerText = rideData.pickup;
    document.getElementById('lbl-drop').innerText = rideData.drop;
    document.getElementById('lbl-vehicle').innerText = rideData.vehicle;
}

// --- GPS LOGIC ---
function getGPS(isAuto = false) {
    const msg = document.getElementById('gps-msg');
    const manualBtn = document.getElementById('btn-manual-gps');
    msg.innerText = isAuto ? "ğŸ“ Auto-fetching location..." : "ğŸ“ Fetching location...";
    msg.className = "gps-status";
    manualBtn.classList.add('hidden');

    if (!navigator.geolocation) {
        msg.innerText = "âŒ GPS not supported";
        msg.className = "gps-status gps-error";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (pos) => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            msg.innerText = "âœ… Location Locked";
            msg.className = "gps-status gps-success";
            manualBtn.classList.add('hidden');
        }, 
        (err) => {
            console.error(err);
            userLocation = null;
            msg.innerText = "âš ï¸ GPS Failed. Please click below.";
            msg.className = "gps-status gps-error";
            manualBtn.classList.remove('hidden');
        },
        { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
    );
}

// --- SUBMIT ---
function submitRide() {
    const pickup = document.getElementById('pickup').value;
    const drop = document.getElementById('drop').value;
    const vehicle = document.getElementById('vehicle').value;
    if (!pickup || !drop) return alert("Please fill all fields");
    if (!userLocation) return alert("GPS Coordinates missing! Please click 'Fetch GPS Manually'.");

    const btnSubmit = document.getElementById('btn-submit');
    const btnReset = document.getElementById('btn-reset');
    btnSubmit.innerText = "Sending...";
    btnSubmit.disabled = true;
    btnReset.classList.add('hidden');

    const requestData = {
        riderId: currentUser.uid,
        riderName: userProfile.name,
        riderPhone: userProfile.phone,
        pickup, drop, vehicle,
        pickup_lat: userLocation.lat,
        pickup_lng: userLocation.lng,
        status: 'pending',
        timestamp: firebase.database.ServerValue.TIMESTAMP
    };

    const newRef = db.ref('requests').push();
    currentRideId = newRef.key;
    newRef.set(requestData).then(() => {
        btnSubmit.innerText = "Submit Request";
        btnSubmit.disabled = false;
        btnReset.classList.remove('hidden');
        showStatusScreen(requestData);
    }).catch(err => {
        alert("Error: " + err.message);
        btnSubmit.innerText = "Submit Request";
        btnSubmit.disabled = false;
        btnReset.classList.remove('hidden');
    });
}

function resetForm() {
    document.getElementById('pickup').value = "";
    document.getElementById('drop').value = "";
    getGPS(true);
}

// --- CANCEL ---
function cancelCurrentRide() {
    if (!currentRideId) return;
    if (!confirm("Are you sure you want to cancel this ride?")) return;
    const uid = currentUser.uid;

    db.ref('requests/' + currentRideId).once('value').then(snapshot => {
        const ride = snapshot.val();
        if (!ride) return;

        if (ride.status === 'confirmed') {
            db.ref('users/' + uid + '/wallet').transaction(balance => (balance >= 250 ? balance-250 : balance));
            db.ref('requests/' + currentRideId).update({
                status:'cancelled_by_rider', penaltyApplied:250, cancelledAt: firebase.database.ServerValue.TIMESTAMP
            });
            alert("âŒ Ride cancelled. Rs.250 penalty applied.");
        } else {
            db.ref('requests/' + currentRideId).update({status:'cancelled_by_rider', cancelledAt: firebase.database.ServerValue.TIMESTAMP});
            alert("Ride cancelled.");
        }

        currentRideId = null;
        showFormScreen();
        resetForm();
    });
}

function logout() { firebase.auth().signOut().then(()=>window.location.href="index.html"); }

// --- TAB LOGIC ---
function showTab(tab) {
    document.getElementById('screen-form').classList.add('hidden');
    document.getElementById('screen-status').classList.add('hidden');
    document.getElementById('tab-history').classList.add('hidden');

    if (tab==='request') showFormScreen();
    else if(tab==='history') {
        document.getElementById('tab-history').classList.remove('hidden');
        loadRideHistory();
    }
}

// --- HISTORY ---
function loadRideHistory() {
    const rideList = document.getElementById('rideList');
    rideList.innerHTML = '';
    db.ref('requests').orderByChild('riderId').equalTo(currentUser.uid).once('value').then(snapshot=>{
        const rides=[];
        snapshot.forEach(child=>{
            const ride = child.val();
            ride._id = child.key;
            if(ride.status==='completed' || ride.status.startsWith('cancelled')) rides.push(ride);
        });
        if(rides.length===0){ rideList.innerHTML="<li>No history found.</li>"; return; }
        rides.sort((a,b)=>b.timestamp-a.timestamp);
        rides.forEach(ride=>{
            const li=document.createElement('li');
            li.style.borderBottom="1px solid #eee";
            li.style.padding="8px 0";
            li.innerHTML=`
                <strong>${ride.status}</strong><br>
                ${ride.pickup} â†’ ${ride.drop}<br>
                <small>${new Date(ride.timestamp).toLocaleString()}</small><br>
                <button onclick="deleteSingleHistory('${ride._id}')" style="margin-top:5px;font-size:11px;">âŒ Delete</button>
            `;
            rideList.appendChild(li);
        });
    });
}
function deleteSingleHistory(id){ if(!confirm("Delete this ride from history?")) return; db.ref('requests/'+id).remove().then(()=>loadRideHistory()); }
function clearAllHistory(){ if(!confirm("Delete ALL old history?")) return; db.ref('requests').orderByChild('riderId').equalTo(currentUser.uid).once('value').then(snapshot=>{ const updates={}; snapshot.forEach(child=>{ const r=child.val(); if(r.status==='completed'||r.status.startsWith('cancelled')) updates[child.key]=null; }); return db.ref('requests').update(updates); }).then(()=>loadRideHistory()); }

</script>
</body>
</html>
