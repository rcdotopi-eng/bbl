<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink - Request Ride</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#007bff">
    <link rel="stylesheet" href="style.css">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body {
            font-family: "Roboto", sans-serif;
            background: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 450px;
            margin: 0 auto;
            padding: 15px;
        }
        .card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h2, h3 { margin: 0 0 15px 0; font-weight: 500; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .input-group input, .input-group select {
            width: 100%; padding: 12px;
            border-radius: 8px; border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }
        .gps-status { font-size: 13px; margin-top: 5px; color: #666; }
        .gps-error { color: #dc3545; font-weight: bold; }
        .gps-success { color: #28a745; font-weight: bold; }
        .btn-primary, .btn-secondary, .btn-danger {
            border: none;
            border-radius: 10px;
            padding: 14px 0;
            font-size: 16px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #565e64; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #a71d2a; }

        /* Status screen */
        #screen-status div { margin-bottom: 10px; }

    </style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>üöñ RideLink</h2>
        <button class="btn-secondary" style="width:auto; padding:6px 12px; font-size:12px;" onclick="logout()">Logout</button>
    </div>

    <div id="screen-loading" class="card" style="text-align:center;">
        <p>Checking profile & active rides...</p>
    </div>

    <!-- REQUEST FORM -->
    <div id="screen-form" class="card hidden">
        <h3>Request a Ride</h3>

        <div class="input-group">
            <label>Pickup Location</label>
            <input type="text" id="pickup" placeholder="Enter Pickup Point">
        </div>

        <div class="input-group">
            <label>Drop Point</label>
            <input type="text" id="drop" placeholder="Enter Destination">
        </div>

        <div class="input-group">
            <label>Vehicle Type</label>
            <select id="vehicle">
                <option value="Bike">Bike üèçÔ∏è</option>
                <option value="Rickshaw">Rickshaw üõ∫</option>
                <option value="Car">Car üöó</option>
            </select>
        </div>

        <div class="input-group">
            <label>Your Phone</label>
            <input type="text" id="phone" readonly style="background:#eee; color:#555;">
        </div>

        <div id="gps-area">
            <p id="gps-msg" class="gps-status">üìç GPS coordinates required</p>
            <button id="btn-manual-gps" class="btn-primary hidden" onclick="getGPS()" style="background:#6c757d;">üìç Click to Fetch GPS Manually</button>
        </div>

        <button id="btn-submit" class="btn-primary" onclick="submitRide()">üöï Submit Ride Request</button>
        <button id="btn-reset" class="btn-secondary" onclick="resetForm()">Reset</button>
    </div>

    <!-- STATUS SCREEN -->
    <div id="screen-status" class="card hidden" style="text-align:center;">
        <div style="font-size: 50px;">‚úÖ</div>
        <h3 style="color:#28a745;">Ride Request Sent</h3>
        <div style="background:#f8f9fa; padding:15px; border-radius:12px; text-align:left; margin-top:10px;">
            <p><strong>Status:</strong> <span style="color:#e67e22; font-weight:bold;">Pending</span></p>
            <p><strong>Pickup:</strong> <span id="lbl-pickup">...</span></p>
            <p><strong>Drop:</strong> <span id="lbl-drop">...</span></p>
            <p><strong>Vehicle:</strong> <span id="lbl-vehicle">...</span></p>
        </div>
        <button disabled style="background:#ddd; color:#555; cursor:default; margin-top:10px;">Submitted (Waiting...)</button>
        <button class="btn-danger" onclick="cancelCurrentRide()">Cancel Request</button>
    </div>

</div>

<script src="firebase-init.js"></script>
<script src="rider_logic.js"></script>
<script>
let currentUser=null, currentRideId=null, userProfile=null, userLocation=null;

// --- AUTH CHECK ---
firebase.auth().onAuthStateChanged((user)=>{
    if(user){ currentUser=user; initialCheck(); }
    else{ window.location.href="index.html"; }
});

function initialCheck(){
    const uid=currentUser.uid;
    db.ref('users/'+uid).once('value').then(snap=>{
        if(!snap.exists()) return window.location.href="index.html";
        userProfile = snap.val();

        if(userProfile.riderStatus!=='active'){
            alert("Account not active. Please complete registration.");
            return window.location.href="index.html";
        }

        if(!userProfile.wallet || userProfile.wallet<250){
            alert("‚ùå Insufficient wallet balance. Minimum Rs.250 required.");
            return window.location.href="wallet.html";
        }

        checkForActiveRides();
    });
}

function checkForActiveRides(){
    db.ref('requests').orderByChild('riderId').equalTo(currentUser.uid).limitToLast(1).once('value').then(snap=>{
        let hasActive=false, activeRideData=null, activeRideKey=null;
        snap.forEach(child=>{
            const r = child.val();
            if(['pending','accepted','confirmed'].includes(r.status)){
                hasActive=true; activeRideData=r; activeRideKey=child.key;
            }
        });
        document.getElementById('screen-loading').classList.add('hidden');
        if(hasActive){ currentRideId=activeRideKey; showStatusScreen(activeRideData); }
        else showFormScreen();
    });
}

// --- SCREEN LOGIC ---
function showFormScreen(){
    document.getElementById('screen-form').classList.remove('hidden');
    document.getElementById('screen-status').classList.add('hidden');
    document.getElementById('phone').value = userProfile.phone || "No Phone Found";
    getGPS(true);
}
function showStatusScreen(rideData){
    document.getElementById('screen-form').classList.add('hidden');
    document.getElementById('screen-status').classList.remove('hidden');
    document.getElementById('lbl-pickup').innerText=rideData.pickup;
    document.getElementById('lbl-drop').innerText=rideData.drop;
    document.getElementById('lbl-vehicle').innerText=rideData.vehicle;
}

// --- GPS ---
function getGPS(isAuto=false){
    const msg=document.getElementById('gps-msg');
    const manualBtn=document.getElementById('btn-manual-gps');
    msg.innerText=isAuto?"üìç Auto-fetching location...":"üìç Fetching location...";
    msg.className="gps-status"; manualBtn.classList.add('hidden');
    if(!navigator.geolocation){ msg.innerText="‚ùå GPS not supported"; msg.className="gps-status gps-error"; return; }

    navigator.geolocation.getCurrentPosition(pos=>{
        userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
        msg.innerText="‚úÖ Location Locked"; msg.className="gps-status gps-success"; manualBtn.classList.add('hidden');
    },err=>{
        console.error(err); userLocation=null;
        msg.innerText="‚ö†Ô∏è GPS Failed. Click below."; msg.className="gps-status gps-error"; manualBtn.classList.remove('hidden');
    }, {enableHighAccuracy:true,timeout:10000,maximumAge:0});
}

// --- SUBMIT ---
function submitRide(){
    const pickup=document.getElementById('pickup').value;
    const drop=document.getElementById('drop').value;
    const vehicle=document.getElementById('vehicle').value;
    if(!pickup||!drop){ alert("Please fill all fields"); return; }
    if(!userLocation){ alert("GPS Coordinates missing!"); return; }

    const btnSubmit=document.getElementById('btn-submit');
    const btnReset=document.getElementById('btn-reset');
    btnSubmit.innerText="Sending..."; btnSubmit.disabled=true; btnReset.classList.add('hidden');

    const requestData={
        riderId:currentUser.uid,
        riderName:userProfile.name,
        riderPhone:userProfile.phone,
        pickup,drop,vehicle,
        pickup_lat:userLocation.lat,
        pickup_lng:userLocation.lng,
        status:'pending',
        timestamp:firebase.database.ServerValue.TIMESTAMP
    };
    const newRef=db.ref('requests').push();
    currentRideId=newRef.key;

    newRef.set(requestData).then(()=>{
        btnSubmit.innerText="Submit Ride Request"; btnSubmit.disabled=false; btnReset.classList.remove('hidden');
        showStatusScreen(requestData);
    }).catch(err=>{
        alert("Error: "+err.message); btnSubmit.innerText="Submit Ride Request"; btnSubmit.disabled=false; btnReset.classList.remove('hidden');
    });
}
function resetForm(){ document.getElementById('pickup').value=""; document.getElementById('drop').value=""; getGPS(true); }

// --- CANCEL ---
function cancelCurrentRide(){
    if(!currentRideId) return; if(!confirm("Cancel this ride?")) return;
    const uid=currentUser.uid;
    db.ref('requests/'+currentRideId).once('value').then(snapshot=>{
        const ride=snapshot.val(); if(!ride) return;
        if(ride.status==='confirmed'){
            db.ref('users/'+uid+'/wallet').transaction(balance=>balance>=250?balance-250:balance);
            db.ref('requests/'+currentRideId).update({status:'cancelled_by_rider',penaltyApplied:250,cancelledAt:firebase.database.ServerValue.TIMESTAMP});
            alert("‚ùå Ride cancelled. Rs.250 penalty applied.");
        } else {
            db.ref('requests/'+currentRideId).update({status:'cancelled_by_rider',cancelledAt:firebase.database.ServerValue.TIMESTAMP});
            alert("Ride cancelled.");
        }
        currentRideId=null;
        showFormScreen(); resetForm();
    });
}

function logout(){ firebase.auth().signOut().then(()=>window.location.href="index.html"); }

</script>
</body>
</html>
