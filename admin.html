<!DOCTYPE html>
<html lang="en">
<head>
    <title>RideLink Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="firebase-init.js"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        
        /* Header & Sidebar */
        .admin-header { background: #1e293b; color: #FFC107; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-radius: 8px; margin-bottom: 20px; }
        
        /* Status Badges */
        .badge-active { background-color: #10b981; color: white; padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-pending { background-color: #f59e0b; color: #fff; padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .badge-blocked { background-color: #ef4444; color: white; padding: 5px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        
        /* History Modal */
        .modal-content { border-radius: 12px; border: none; }
        .history-item { border-left: 3px solid #ddd; padding-left: 15px; margin-bottom: 15px; position: relative; }
        .history-item.completed { border-color: #10b981; }
        .history-item.cancelled { border-color: #ef4444; }
        .history-date { font-size: 11px; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }

        .stat-val { font-size: 1.8rem; font-weight: 700; color: #333; }
        .nav-link { cursor: pointer; color: #64748b; font-weight: 600; transition: all 0.2s; }
        .nav-link.active { color: #1e293b !important; border-bottom: 3px solid #FFC107 !important; background: transparent; }
        
        .btn-action { font-size: 12px; margin: 0 2px; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="admin-login" class="container text-center" style="margin-top: 100px;">
        <div class="card p-5 mx-auto" style="max-width: 400px;">
            <h3>üõ°Ô∏è Admin Panel</h3>
            <p class="text-muted">RideLink Management</p>
            <button class="btn btn-dark btn-block" onclick="adminLogin()">Sign in with Google</button>
            <p id="error-msg" class="text-danger mt-3 small"></p>
        </div>
    </div>

    <div id="admin-dashboard" style="display: none;">
        <div class="admin-header">
            <h5 style="margin:0;">üöñ RideLink Control</h5>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="admin-email" style="font-size: 12px; color: #ccc;"></span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="container mt-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <h6 class="text-muted small text-uppercase">Active Drivers</h6>
                        <div class="stat-val" id="count-drivers">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <h6 class="text-muted small text-uppercase">Passengers</h6>
                        <div class="stat-val" id="count-riders">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <h6 class="text-warning small text-uppercase">Pending Approval</h6>
                        <div class="stat-val" id="count-pending">0</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3 text-center">
                        <h6 class="text-success small text-uppercase">System Wallet</h6>
                        <div class="stat-val" id="total-money">0</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-white pb-0 pt-3">
                    <ul class="nav nav-tabs border-0">
                        <li class="nav-item">
                            <a class="nav-link active" id="tab-drivers" onclick="switchTab('drivers')">üöô Captains</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="tab-riders" onclick="switchTab('riders')">üë§ Passengers</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="bg-light text-muted">
                                <tr>
                                    <th class="pl-4 border-0">User Profile</th>
                                    <th class="border-0">Details</th>
                                    <th class="border-0">Wallet</th>
                                    <th class="border-0">Status</th>
                                    <th class="text-right pr-4 border-0">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ride History</h5>
                    <button type="button" class="close" onclick="$('#historyModal').modal('hide')"><span>&times;</span></button>
                </div>
                <div class="modal-body" id="history-content">
                    <div class="text-center text-muted p-4">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. CONFIGURATION ---
        // REPLACE with your specific admin email
        const ALLOWED_ADMINS = ["rcdotopi@gmail.com"]; 
        
        let currentTab = 'drivers';
        let driversData = {};
        let ridersData = {};
        let requestsData = {}; // Store all rides for history lookup

        // --- 2. AUTHENTICATION ---
        window.onload = function() {
            firebase.auth().onAuthStateChanged(user => {
                if (user && ALLOWED_ADMINS.includes(user.email)) {
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-dashboard').style.display = 'block';
                    document.getElementById('admin-email').innerText = user.email;
                    initRealtimeListeners();
                } else {
                    document.getElementById('admin-login').style.display = 'block';
                    document.getElementById('admin-dashboard').style.display = 'none';
                    if(user) {
                        document.getElementById('error-msg').innerText = "Access Denied: Not an Admin";
                        firebase.auth().signOut();
                    }
                }
            });
        };

        function adminLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            firebase.auth().signInWithPopup(provider).catch(e => alert(e.message));
        }

        function logout() {
            firebase.auth().signOut().then(() => location.reload());
        }

        // --- 3. DATA FETCHING ---
        function initRealtimeListeners() {
            // Listen to Drivers
            db.ref('drivers').on('value', snap => {
                driversData = snap.val() || {};
                updateUI();
            });

            // Listen to Passengers (Users)
            db.ref('users').on('value', snap => {
                ridersData = snap.val() || {};
                updateUI();
            });

            // Listen to Requests (For History)
            db.ref('requests').on('value', snap => {
                requestsData = snap.val() || {};
            });
        }

        // --- 4. UI RENDERING ---
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-drivers').classList.remove('active');
            document.getElementById('tab-riders').classList.remove('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            updateUI();
        }

        function updateUI() {
            renderStats();
            renderTable();
        }

        function renderStats() {
            let dCount = 0, rCount = 0, pCount = 0, money = 0;

            // Calc Drivers
            Object.values(driversData).forEach(d => {
                if(d.status === 'active') dCount++;
                if(d.status === 'pending') pCount++;
                money += (d.wallet || 0);
            });

            // Calc Riders
            Object.values(ridersData).forEach(r => {
                if(r.riderStatus === 'active') rCount++; 
                money += (r.wallet || 0);
            });

            document.getElementById('count-drivers').innerText = dCount;
            document.getElementById('count-riders').innerText = rCount;
            document.getElementById('count-pending').innerText = pCount;
            document.getElementById('total-money').innerText = "Rs. " + money.toLocaleString();
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const data = currentTab === 'drivers' ? driversData : ridersData;
            
            if (Object.keys(data).length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted">No records found.</td></tr>`;
                return;
            }

            Object.keys(data).forEach(uid => {
                const row = data[uid];
                
                // Determine Status
                let status = currentTab === 'drivers' ? row.status : (row.riderStatus || 'active');
                if(!status) status = 'pending';

                let badge = '';
                if(status === 'active') badge = '<span class="badge-active">ACTIVE</span>';
                else if(status === 'pending') badge = '<span class="badge-pending">PENDING</span>';
                else badge = '<span class="badge-blocked">BLOCKED</span>';

                // Details Column
                let details = '';
                if(currentTab === 'drivers') {
                    details = `
                        <small style="color:#666;">
                            <b>${row.vehicleType || 'Unknown'}</b><br>
                            ${row.vehicleModel || ''}<br>
                            Plate: <span style="background:#eee; padding:2px 4px; border-radius:4px;">${row.vehiclePlate || 'N/A'}</span>
                        </small>
                    `;
                } else {
                    details = `<small class="text-muted">Joined: ${new Date(row.joined || Date.now()).toLocaleDateString()}</small>`;
                }

                // Wallet Color
                const wallet = row.wallet || 0;
                const walletColor = wallet < 0 ? 'text-danger' : 'text-success';

                // Action Buttons
                let actions = `
                    <button class="btn btn-sm btn-light border btn-action" title="Edit Wallet" onclick="editWallet('${uid}', ${wallet})">üí∞</button>
                    <button class="btn btn-sm btn-light border btn-action" title="View History" onclick="viewHistory('${uid}')">üìú</button>
                    <button class="btn btn-sm btn-light border btn-action text-danger" title="Block/Unblock" onclick="toggleBlock('${uid}', '${status}')">üö´</button>
                    <button class="btn btn-sm btn-light border btn-action" title="Delete" onclick="deleteUser('${uid}')">üóë</button>
                `;

                // Add Approve Button for Pending Drivers
                if(status === 'pending') {
                    actions = `
                        <button class="btn btn-sm btn-success btn-action mb-1" style="width:100%" onclick="approveDriver('${uid}')">‚úÖ Approve License</button>
                        <br>${actions}
                    `;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="pl-4">
                        <div style="font-weight:600; color:#333;">${row.name || 'Unknown'}</div>
                        <small class="text-muted">${row.phone || row.email || 'No contact'}</small>
                    </td>
                    <td>${details}</td>
                    <td class="font-weight-bold ${walletColor}">Rs. ${wallet}</td>
                    <td>${badge}</td>
                    <td class="text-right pr-4">${actions}</td>
                `;
                tbody.append(tr);
            });
        }

        // --- 5. HISTORY VIEWER ---
        window.viewHistory = function(uid) {
            $('#historyModal').modal('show');
            const container = document.getElementById('history-content');
            container.innerHTML = '<div class="text-center p-3">Loading history...</div>';

            let html = "";
            let count = 0;

            // Sort requests by time (newest first)
            const sortedRequests = Object.values(requestsData).sort((a, b) => b.timestamp - a.timestamp);

            sortedRequests.forEach(req => {
                // Check if this request involves the user (either as driver or rider)
                if (req.driverId === uid || req.riderId === uid) {
                    count++;
                    const date = new Date(req.timestamp).toLocaleString();
                    const statusClass = req.status === 'completed' ? 'completed' : (req.status.includes('cancel') ? 'cancelled' : '');
                    
                    html += `
                        <div class="history-item ${statusClass}">
                            <div class="history-date">${date}</div>
                            <div style="font-weight:600; font-size:14px;">${req.pickup} ‚ûî ${req.drop}</div>
                            <div style="font-size:12px; display:flex; justify-content:space-between; margin-top:5px;">
                                <span>Status: <b>${req.status}</b></span>
                                <span>Price: Rs. ${req.price || 'N/A'}</span>
                            </div>
                        </div>
                    `;
                }
            });

            if (count === 0) {
                container.innerHTML = `<div class="text-center text-muted p-4">No ride history found for this user.</div>`;
            } else {
                container.innerHTML = html;
            }
        };

        // --- 6. ADMIN ACTIONS ---

        window.approveDriver = function(uid) {
            if(confirm("Verify and Approve this driver?")) {
                db.ref('drivers/' + uid).update({ status: 'active' });
            }
        };

        window.toggleBlock = function(uid, currentStatus) {
            const collection = currentTab === 'drivers' ? 'drivers' : 'users';
            const field = currentTab === 'drivers' ? 'status' : 'riderStatus';
            const newStatus = currentStatus === 'blocked' ? 'active' : 'blocked';
            
            if(confirm(`Change status to ${newStatus}?`)) {
                db.ref(`${collection}/${uid}`).update({ [field]: newStatus });
            }
        };

        window.editWallet = function(uid, currentVal) {
            const collection = currentTab === 'drivers' ? 'drivers' : 'users';
            const input = prompt("Enter new Wallet Balance:", currentVal);
            if(input !== null) {
                const amount = parseInt(input);
                if(!isNaN(amount)) {
                    db.ref(`${collection}/${uid}`).update({ wallet: amount });
                }
            }
        };

        window.deleteUser = function(uid) {
            const collection = currentTab === 'drivers' ? 'drivers' : 'users';
            if(confirm("Are you sure? This cannot be undone.")) {
                db.ref(`${collection}/${uid}`).remove();
            }
        };
    </script>
</body>
</html>
